
select DO.OutputID as OutputID, DOP.Value as TableName
from [dbo].[DeliveryOutput] DO	
  left outer join dbo.DeliveryOutputParameters DOP
	on DO.DeliveryID = DOP.DeliveryID and DO.OutputID = DOP.OutputID
 where DO.Status = 7 and DOP.[Key] = 'CommitTableName';
 

-- This SP will find the "pending roll back" delivery outputs, delete it from the DWH db, and change it's status to rolledback.
-- The SP belongs to system db

Declare @OutputIDs as nvarchar(4000);
Declare @TableNames as nvarchar(4000);
Declare @CurrentTableName as nvarchar(4000);
Declare @CurrentOutputID as nvarchar(4000);
Declare @sql as nvarchar(4000);

 --Drop table #OutputAndTable;
 -- Drop table #DistinctTables;


-- Find all the "pending roll back" statuses (7) in delivery output table. the data stored is table name and outputID

	select DO.OutputID as OutputID, DOP.Value as TableName
	into #OutputAndTable
	from [dbo].[DeliveryOutput] DO	
	  left outer join dbo.DeliveryOutputParameters DOP
		on DO.DeliveryID = DOP.DeliveryID and DO.OutputID = DOP.OutputID
	 where DO.Status = 7 and DOP.[Key] = 'CommitTableName';
	 
	Select distinct TableName
	into #DistinctTables
	from #OutputAndTable

 -- Populate the table names list		
	select @TableNames = COALESCE(@TableNames+'', '','''')+ ISNULL(TableName+',','''')
	from  #DistinctTables;
	
print '@TableNames: ' + @TableNames 
 
 -- For each table name - delete all the outputIDs in that table
while LEN(@TableNames) > 0 
	BEGIN 
-- get current table 
	set @CurrentTableName = SUBSTRING(@TableNames,0,CHARINDEX(',',@TableNames,0));
print @currentTableName;
	
 -- Clear and populate the OutputID list which belongs to the current table name
	set @OutputIDs = ''
	select @OutputIDs = COALESCE(@OutputIDs+'', '','''')+ISNULL(OutputID+',','''')
	from  #OutputAndTable
	where TableName = @CurrentTableName;
	
print @OutputIDs
	set @sql = ''	
	set @sql = 'delete from ' + @CurrentTableName +' where outputID in ('+ @OutputIDs +')';
print @sql

-- After deletion set the status to "Rolledback" in the delivery output table
	set @sql = ''
	set @sql = 'update [dbo].[DeliveryOutput] 
				set [Status] = 5 
				where outputID in ('+ @OutputIDs +')'
print @sql
			

	
-- Delete the current table name from @TableNames
	set @TableNames = SUBSTRING(@TableNames,CHARINDEX(',',@TableNames,0),3999);
print @TableNames;
	END	
	
	
	 
 
 
 
 
 


-- and delete it from the DWH table (find the current table from the delivery output parameters "CommitTableName"), 
-- than change the status to rolledback (5).